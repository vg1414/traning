<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√§ningslogg</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Tr√§ningslogg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --surface2: #21262d;
            --border: #30363d;
            --text: #e6edf3;
            --muted: #8b949e;
            --c-brost: #ff6b6b;
            --c-rygg: #4fc3f7;
            --c-axlar: #c084fc;
            --c-cardio: #4ade80;
            --c-ben: #fb923c;
            --c-helkropp: #facc15;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .top-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .top-bar h1 { font-size: 18px; font-weight: 600; flex: 1; }
        .top-bar h1 span { color: var(--muted); font-weight: 400; }

        .btn-icon {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 18px;
            line-height: 1;
            transition: all 0.15s;
        }
        .btn-icon:hover { background: var(--surface2); color: var(--text); }

        /* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
        .home-body {
            max-width: 560px;
            margin: 0 auto;
            padding: 32px 20px 40px;
        }

        .home-greeting {
            text-align: center;
            margin-bottom: 28px;
        }
        .home-greeting h2 { font-size: 26px; font-weight: 700; margin-bottom: 4px; }
        .home-greeting p { color: var(--muted); font-size: 14px; }

        .workout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 24px;
        }

        .wcard {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 26px 16px 22px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .wcard::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .wcard:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .wcard:hover::before { opacity: 1; }
        .wcard:active { transform: translateY(0); }

        .wcard .icon { font-size: 38px; margin-bottom: 10px; display: block; }
        .wcard h3 { font-size: 14px; font-weight: 600; color: var(--accent); }
        .wcard .last-session { font-size: 11px; color: var(--muted); margin-top: 4px; }

        .wcard-brost { --accent: var(--c-brost); }
        .wcard-rygg  { --accent: var(--c-rygg); }
        .wcard-axlar { --accent: var(--c-axlar); }
        .wcard-cardio{ --accent: var(--c-cardio); }
        .wcard-ben   { --accent: var(--c-ben); }

        /* ‚îÄ‚îÄ SIGNATURE ‚îÄ‚îÄ */
        .signature {
            position: fixed;
            bottom: 6px;
            left: 0; right: 0;
            text-align: center;
            font-size: 11px;
            color: #333d47;
            pointer-events: none;
            z-index: 5;
        }

        .history-btn {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 13px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-btn:hover { background: var(--surface2); color: var(--text); border-color: #58a6ff; }

        .programs-btn {
            width: 100%;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            border: none;
            color: #000;
            padding: 20px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 16px rgba(245,158,11,0.3);
        }
        .programs-btn:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(245,158,11,0.4); }
        .programs-btn:active { transform: translateY(0); }

        /* ‚îÄ‚îÄ PROGRAM SESSION ‚îÄ‚îÄ */
        .prog-session-body {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }
        .prog-session-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px 20px 20px;
            margin-bottom: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .prog-session-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--pc);
        }
        .prog-session-emoji { font-size: 48px; display: block; margin-bottom: 12px; }
        .prog-session-name { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
        .prog-session-sub { font-size: 13px; color: var(--muted); margin-top: 3px; }

        .prog-ex-list {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 4px 16px;
            margin-bottom: 24px;
        }
        .prog-ex-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--surface2);
            font-size: 14px;
        }
        .prog-ex-item:last-child { border-bottom: none; }
        .prog-ex-section {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            padding: 14px 0 4px;
            text-align: center;
        }

        .diff-section {
            text-align: center;
            margin-bottom: 24px;
        }
        .diff-label {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 14px;
            font-weight: 500;
            min-height: 20px;
        }
        .diff-stars {
            display: flex;
            justify-content: center;
            gap: 6px;
        }
        .diff-star {
            font-size: 40px;
            cursor: pointer;
            color: var(--border);
            transition: all 0.15s;
            user-select: none;
            line-height: 1;
        }
        .diff-star.active { color: #facc15; }
        .diff-star:hover { transform: scale(1.15); }

        .hist-prog-row { font-size: 14px; color: var(--muted); }
        .hist-prog-stars { color: #facc15; font-size: 20px; letter-spacing: 2px; display: block; margin-top: 4px; }

        /* ‚îÄ‚îÄ EXERCISE SECTION HEADERS (f√∂r cirkelpass) ‚îÄ‚îÄ */
        .ex-section-head {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 22px 0 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
        }
        .ex-section-head::before, .ex-section-head::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .ex-section-head:first-child { margin-top: 4px; }

        /* ‚îÄ‚îÄ EXERCISE IMAGE THUMBNAIL ‚îÄ‚îÄ */
        .ex-thumb {
            width: 78px;
            height: 56px;
            object-fit: cover;
            border-radius: 7px;
            cursor: pointer;
            opacity: 0.82;
            flex-shrink: 0;
            transition: opacity 0.15s, transform 0.15s;
            border: 1px solid var(--border);
        }
        .ex-thumb:hover { opacity: 1; transform: scale(1.06); }

        /* ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.88);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            cursor: zoom-out;
        }
        .lightbox.open { display: flex; }
        .lightbox img {
            max-width: 94vw;
            max-height: 86vh;
            border-radius: 10px;
            object-fit: contain;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }
        .lightbox-close {
            position: absolute;
            top: 16px; right: 20px;
            font-size: 28px;
            color: #fff;
            cursor: pointer;
            line-height: 1;
            opacity: 0.7;
        }
        .lightbox-close:hover { opacity: 1; }

        /* ‚îÄ‚îÄ WORKOUT ‚îÄ‚îÄ */
        .workout-body {
            max-width: 680px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }

        .session-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #000;
        }
        .session-date { font-size: 13px; color: var(--muted); }
        .prev-session-info { font-size: 12px; color: var(--muted); margin-left: auto; font-style: italic; }

        .ex-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 14px;
            overflow: hidden;
        }
        .ex-header {
            padding: 13px 16px;
            border-bottom: 1px solid var(--surface2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ex-name { font-weight: 600; font-size: 15px; }
        .ex-pb { font-size: 11px; color: #facc15; opacity: 0.75; margin-top: 2px; }
        .variant-select {
            display: block;
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            font-size: 12px;
            padding: 3px 8px;
            margin-top: 5px;
            cursor: pointer;
        }

        .sets-table { width: 100%; border-collapse: collapse; }
        .sets-table thead tr { background: var(--bg); }
        .sets-table th {
            color: var(--muted);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 14px;
            text-align: left;
        }
        .sets-table th:last-child { width: 40px; }

        .set-row td { padding: 7px 14px; border-bottom: 1px solid var(--surface2); }
        .set-row:last-child td { border-bottom: none; }
        .set-num { color: var(--muted); font-size: 13px; width: 32px; }

        .set-input {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 16px;
            width: 88px;
            transition: border-color 0.15s;
        }
        .set-input:focus { outline: none; border-color: #58a6ff; }

        .prev-val { font-size: 11px; color: var(--muted); margin-top: 2px; }

        .del-set {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 20px;
            padding: 8px 12px;
            border-radius: 4px;
            line-height: 1;
            transition: all 0.15s;
        }
        .del-set:hover { color: #f85149; background: rgba(248,81,73,0.1); }

        .add-set-btn {
            display: block;
            width: 100%;
            background: none;
            border: none;
            border-top: 1px dashed var(--border);
            color: #58a6ff;
            cursor: pointer;
            padding: 10px;
            font-size: 13px;
            transition: background 0.15s;
        }
        .add-set-btn:hover { background: var(--surface2); }

        .save-btn {
            width: 100%;
            background: #238636;
            border: none;
            color: #fff;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .save-btn:hover { background: #2ea043; }
        .save-btn:active { background: #1a7f37; }

        /* ‚îÄ‚îÄ USER SELECT ‚îÄ‚îÄ */
        .user-select-body {
            max-width: 440px;
            margin: 0 auto;
            padding: 56px 24px 40px;
            text-align: center;
        }
        .user-select-body h2 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .user-select-body p  { color: var(--muted); font-size: 15px; margin-bottom: 44px; }

        .user-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .user-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 18px;
            padding: 36px 16px 28px;
            cursor: pointer;
            text-align: center;
            transition: all 0.22s;
            position: relative;
            overflow: hidden;
        }
        .user-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--uc);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .user-card:hover { border-color: var(--uc); transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.45); }
        .user-card:hover::before { opacity: 1; }
        .user-card:active { transform: translateY(0); }
        .u-avatar { font-size: 54px; display: block; margin-bottom: 14px; }
        .u-name { font-size: 22px; font-weight: 700; color: var(--uc); }
        .user-card-emma  { --uc: #f472b6; }
        .user-card-david { --uc: #38bdf8; }

        .switch-user-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.15s;
        }
        .switch-user-btn:hover { color: var(--text); background: var(--surface2); }

        /* ‚îÄ‚îÄ CARDIO ‚îÄ‚îÄ */
        .cardio-body {
            max-width: 480px;
            margin: 0 auto;
            padding: 24px 20px 40px;
        }
        .cardio-body h2 { font-size: 16px; font-weight: 600; color: var(--muted); margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.5px; }

        .activity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 28px;
        }
        .act-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px 10px 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .act-card:hover { border-color: var(--c-cardio); background: var(--surface2); }
        .act-card.selected { border-color: var(--c-cardio); background: rgba(74,222,128,0.08); }
        .act-card .icon { font-size: 30px; display: block; margin-bottom: 8px; }
        .act-card span { font-size: 13px; color: var(--muted); transition: color 0.2s; }
        .act-card.selected span { color: var(--c-cardio); font-weight: 600; }

        .form-row { margin-bottom: 18px; }
        .form-row label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
        .form-row input {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: 12px 14px;
            width: 100%;
            font-size: 16px;
            transition: border-color 0.15s;
        }
        .form-row input:focus { outline: none; border-color: var(--c-cardio); }

        .save-btn-cardio {
            background: #166534;
            border: none;
            color: #fff;
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .save-btn-cardio:hover { background: #15803d; }

        /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
        .history-body {
            max-width: 640px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }
        .history-empty { text-align: center; color: var(--muted); padding: 60px 0; font-size: 15px; }

        .hist-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .hist-header {
            padding: 13px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }
        .hist-header.open { border-bottom-color: var(--surface2); }
        .hist-title { font-weight: 600; flex: 1; }
        .hist-date { font-size: 12px; color: var(--muted); }
        .hist-chevron { color: var(--muted); font-size: 12px; transition: transform 0.2s; }
        .hist-header.open .hist-chevron { transform: rotate(180deg); }
        .hist-delete-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            cursor: pointer;
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.15s;
        }
        .hist-delete-btn:hover { color: #f85149; border-color: #f85149; background: rgba(248,81,73,0.08); }

        .hist-edit-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 15px;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.15s;
            line-height: 1;
            flex-shrink: 0;
        }
        .hist-edit-btn:hover { color: #58a6ff; background: rgba(88,166,255,0.1); }

        .hist-body { display: none; padding: 14px 16px; }
        .hist-body.open { display: block; }

        .hist-ex { margin-bottom: 12px; }
        .hist-ex:last-child { margin-bottom: 0; }
        .hist-ex-name { font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--muted); }
        .hist-sets { display: flex; gap: 8px; flex-wrap: wrap; }
        .hist-set-pill {
            background: var(--surface2);
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 13px;
        }

        .hist-cardio-info { font-size: 14px; color: var(--muted); }
        .hist-cardio-info strong { color: var(--text); }

        /* ‚îÄ‚îÄ HISTORY WEEK GROUPS ‚îÄ‚îÄ */
        .week-group { margin-bottom: 24px; }
        .week-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 0 2px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .week-header::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .stats-body {
            max-width: 640px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }
        .stats-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 14px;
        }
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px 12px;
            text-align: center;
        }
        .stat-value { font-size: 34px; font-weight: 700; line-height: 1; margin-bottom: 5px; }
        .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }

        .chart-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px 16px 14px;
            margin-bottom: 14px;
        }
        .chart-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
        }
        .bar-chart {
            display: flex;
            align-items: stretch;
            gap: 4px;
            height: 150px;
            overflow-x: auto;
        }
        .bar-group {
            flex: 1;
            min-width: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        .bar-val {
            font-size: 12px;
            font-weight: 700;
            color: #58a6ff;
            min-height: 15px;
            line-height: 15px;
            text-align: center;
        }
        .bar-col {
            width: 65%;
            max-width: 30px;
            min-height: 2px;
            border-radius: 3px 3px 0 0;
            background: linear-gradient(to top, #1f6feb, #58a6ff);
        }
        .bar-lbl {
            font-size: 11px;
            color: var(--muted);
            padding-top: 5px;
            text-align: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .fun-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        .fun-stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 8px 12px;
            text-align: center;
        }
        .fun-stat-emoji { font-size: 20px; display: block; margin-bottom: 5px; }
        .fun-stat-val { font-size: 22px; font-weight: 700; line-height: 1.1; margin-bottom: 4px; color: var(--text); }
        .fun-stat-desc { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.3px; font-weight: 500; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: #238636;
            color: #fff;
            padding: 11px 22px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            z-index: 100;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: #b91c1c; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 440px) {
            .workout-grid { grid-template-columns: 1fr; }
            .activity-grid { grid-template-columns: 1fr 1fr; }
            .wcard { padding: 20px 12px 16px; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USER SELECT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-user" class="screen active">
    <div class="top-bar">
        <h1>Tr√§ningslogg</h1>
    </div>
    <div class="user-select-body">
        <h2>Vem tr√§nar idag?</h2>
        <p>V√§lj din profil f√∂r att komma ig√•ng</p>
        <div class="user-grid">
            <div class="user-card user-card-emma" onclick="selectUser('Emma')">
                <span class="u-avatar">üë©</span>
                <div class="u-name">Emma</div>
            </div>
            <div class="user-card user-card-david" onclick="selectUser('David')">
                <span class="u-avatar">üë®</span>
                <div class="u-name">David</div>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-home" class="screen">
    <div class="top-bar">
        <h1>Tr√§ningslogg</h1>
        <button class="switch-user-btn" onclick="switchUser()" title="Byt anv√§ndare">‚áÑ Byt</button>
    </div>
    <div class="home-body">
        <div class="home-greeting">
            <h2 id="home-greeting-name"></h2>
            <p id="home-date"></p>
        </div>
        <div class="workout-grid">
            <div class="wcard wcard-brost" onclick="startWorkout('brost')">
                <span class="icon">üí™</span>
                <h3>Br√∂st & Triceps</h3>
                <div class="last-session" id="last-brost"></div>
            </div>
            <div class="wcard wcard-rygg" onclick="startWorkout('rygg')">
                <span class="icon">üèãÔ∏è</span>
                <h3>Rygg & Biceps</h3>
                <div class="last-session" id="last-rygg"></div>
            </div>
            <div class="wcard wcard-axlar" onclick="startWorkout('axlar')">
                <span class="icon">üîÜ</span>
                <h3>Axlar & Mage</h3>
                <div class="last-session" id="last-axlar"></div>
            </div>
            <div class="wcard wcard-cardio" onclick="startWorkout('cardio')">
                <span class="icon">üèÉ</span>
                <h3>Cardio</h3>
                <div class="last-session" id="last-cardio"></div>
            </div>
            <div class="wcard wcard-ben" onclick="startWorkout('ben')">
                <span class="icon">ü¶µ</span>
                <h3>Ben & Rumpa</h3>
                <div class="last-session" id="last-ben"></div>
            </div>
        </div>
        <button class="programs-btn" onclick="startRandomHelkropp()">üé≤ &nbsp; Slumpa helkroppspass</button>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
            <button class="history-btn" onclick="showHistory()">üìã &nbsp; Historik</button>
            <button class="history-btn" onclick="showStats()">üìä &nbsp; Statistik</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORKOUT (STYRKA) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-workout" class="screen">
    <div class="top-bar">
        <button class="btn-icon" onclick="goHome()">‚Üê</button>
        <h1 id="workout-title"></h1>
    </div>
    <div class="workout-body">
        <div class="session-meta">
            <span class="badge" id="workout-badge"></span>
            <span class="session-date" id="workout-date"></span>
            <span class="prev-session-info" id="prev-session-info"></span>
        </div>
        <div id="exercises-list"></div>
        <button class="save-btn" onclick="saveWorkout()">Spara tr√§ningspass</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARDIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-cardio" class="screen">
    <div class="top-bar">
        <button class="btn-icon" onclick="goHome()">‚Üê</button>
        <h1>Cardio</h1>
    </div>
    <div class="cardio-body">
        <h2>V√§lj aktivitet</h2>
        <div class="activity-grid">
            <div class="act-card" onclick="selectActivity(this,'cykel')">
                <span class="icon">üö¥</span>
                <span>Cykel</span>
            </div>
            <div class="act-card" onclick="selectActivity(this,'promenad')">
                <span class="icon">üö∂</span>
                <span>Promenad</span>
            </div>
            <div class="act-card" onclick="selectActivity(this,'crosstrainer')">
                <span class="icon">üéø</span>
                <span>Crosstrainer</span>
            </div>
        </div>

        <div class="form-row">
            <label>Tid (minuter)</label>
            <input type="number" id="cardio-time" placeholder="45" min="1" inputmode="numeric">
        </div>
        <div class="form-row">
            <label>Kalorier (kcal)</label>
            <input type="number" id="cardio-kcal" placeholder="350" min="1" inputmode="numeric">
        </div>
        <button class="save-btn-cardio" onclick="saveCardio()">Spara Cardio</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROGRAMS (slumpm√§ssigt helkroppspass) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-programs" class="screen">
    <div class="top-bar">
        <button class="btn-icon" onclick="goHome()">‚Üê</button>
        <h1 id="prog-session-title">Helkroppspass</h1>
    </div>
    <div class="prog-session-body">
        <div class="prog-session-card" id="prog-session-card"></div>
        <div class="prog-ex-list" id="prog-ex-list"></div>
        <div class="diff-section">
            <div class="diff-label" id="diff-label">Hur jobbigt var det?</div>
            <div class="diff-stars">
                <span class="diff-star" onclick="setDifficulty(1)">‚òÖ</span>
                <span class="diff-star" onclick="setDifficulty(2)">‚òÖ</span>
                <span class="diff-star" onclick="setDifficulty(3)">‚òÖ</span>
                <span class="diff-star" onclick="setDifficulty(4)">‚òÖ</span>
                <span class="diff-star" onclick="setDifficulty(5)">‚òÖ</span>
            </div>
        </div>
        <button class="save-btn" onclick="saveProgramSession()">Spara tr√§ningspass</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATISTICS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-stats" class="screen">
    <div class="top-bar">
        <button class="btn-icon" onclick="goHome()">‚Üê</button>
        <h1>Statistik</h1>
    </div>
    <div class="stats-body" id="stats-body"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-history" class="screen">
    <div class="top-bar">
        <button class="btn-icon" onclick="goHome()">‚Üê</button>
        <h1>Historik</h1>
    </div>
    <div class="history-body" id="history-list"></div>
</div>

<div class="toast" id="toast"></div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">√ó</span>
    <img id="lightbox-img" src="" alt="">
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
    apiKey: "AIzaSyBIRuqAwzaG9LZz2XjYlBNTZhEMk8RrR-8",
    authDomain: "traning-f6957.firebaseapp.com",
    projectId: "traning-f6957",
    storageBucket: "traning-f6957.firebasestorage.app",
    messagingSenderId: "508636489314",
    appId: "1:508636489314:web:b0ec532f0c4bedf3c5933b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
db.enablePersistence().catch(() => {});

function userRef() {
    return db.collection('users').doc(currentUser.toLowerCase()).collection('workouts');
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WORKOUTS = {
    brost: {
        title: 'Br√∂st & Triceps',
        color: '#ff6b6b',
        groups: [
            { label: 'Br√∂st', exercises: ['B√§nkpress', 'Lutande hantelpress', 'Rak hantelpress', 'Low cable chest', 'Pec deck', 'Br√∂stpress', 'High to low cable flyes (drag curl)', 'Low to high cable fly'] },
            { label: 'Triceps', exercises: ['Pushdowns', 'Overhead tricep extension', 'Cable kickback triceps'] }
        ]
    },
    rygg: {
        title: 'Rygg & Biceps',
        color: '#4fc3f7',
        groups: [
            { label: 'Rygg', exercises: ['Latsdrag', 'Sittande rodd', 'Hyperextensions'] },
            { label: 'Biceps', exercises: ['Preacher curl', 'Bak√•tlutad bicepcurl', 'Cable curl', 'One arm cable curl'] }
        ]
    },
    axlar: {
        title: 'Axlar & Mage',
        color: '#c084fc',
        groups: [
            { label: 'Axlar', exercises: ['Milit√§rpress', 'Sidolyft', 'Framlyft', 'Face pull'] },
            { label: 'Mage', exercises: ['Plankan (sek)', 'Sidoplanka (sek)', 'Dead bug', 'Hjulet'] }
        ]
    },
    ben: {
        title: 'Ben & Rumpa',
        color: '#fb923c',
        groups: [
            { label: 'Ben', exercises: ['Kn√§b√∂j', 'Benpress', 'Leg extension', 'Leg curl', 'Utfall'] },
            { label: 'Rumpa', exercises: ['Hip thrust', 'Romanian deadlift', 'Sumo kn√§b√∂j', 'Cable kickback'] }
        ]
    },
    helkropp: { title: 'Helkropp', color: '#facc15', groups: [] }
};

// ‚îÄ‚îÄ HELKROPPSPASS (slumpas vid knapptryck) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HELKROPP_PROGRAMS = [
    {
        id: 'hiit_klassisk',
        title: 'Cirkelfys ‚Äì Klassisk',
        subtitle: '3 varv ¬∑ 40 sek arbete / 20 sek vila',
        emoji: '‚ö°',
        color: '#facc15',
        duration: '40‚Äì50 min',
        exercises: [
            '‚Äî Uppv√§rmning (5 min) ‚Äî',
            'Hopphopp ‚Äì 2 √ó 30 sek',
            'High knees ‚Äì 2 √ó 30 sek',
            'Armcirklar ‚Äì 1 √ó 20',
            'Dynamisk h√∂ft√∂ppnare ‚Äì 1 √ó 10/ben',
            '‚Äî Cirkel, 3 varv (40 sek / 20 sek vila) ‚Äî',
            'Burpees',
            'Jump squats',
            'Push-ups',
            'Mountain climbers',
            'Reverse lunges',
            'H√∂ftlyft (golv)',
            'Plankan',
            '‚Äî Nedvarvning (5 min) ‚Äî',
            'H√∂ftstr√§ckning ‚Äì 45 sek',
            'Hamstrings stretch ‚Äì 45 sek',
            'Br√∂ststr√§ckning ‚Äì 45 sek',
        ]
    },
    {
        id: 'hiit_tabata',
        title: 'Tabata-pass',
        subtitle: '4 √∂vningar ¬∑ 8 varv var ¬∑ 20 sek / 10 sek',
        emoji: 'üî•',
        color: '#f43f5e',
        duration: '30‚Äì40 min',
        exercises: [
            '‚Äî Uppv√§rmning (5 min) ‚Äî',
            'L√§tt jogg p√• st√§llet ‚Äì 2 min',
            'Benpendlar ‚Äì 1 √ó 10/ben',
            'Armsv√§ngningar ‚Äì 1 √ó 20',
            '‚Äî Tabata (4 min per √∂vning, 20 sek / 10 sek) ‚Äî',
            '‚Üª Burpees ‚Äì 8 varv',
            '‚Üª Jump squats ‚Äì 8 varv',
            '‚Üª Push-ups ‚Äì 8 varv',
            '‚Üª Mountain climbers ‚Äì 8 varv',
            '‚Äî Nedvarvning (5 min) ‚Äî',
            'Full kroppsstretching ‚Äì 5 min',
        ]
    },
    {
        id: 'hiit_styrka',
        title: 'Styrke-HIIT',
        subtitle: '4 varv ¬∑ Tyngre r√∂relser + kondition ¬∑ 45/15 sek',
        emoji: 'üí•',
        color: '#f97316',
        duration: '45‚Äì55 min',
        exercises: [
            '‚Äî Uppv√§rmning (5 min) ‚Äî',
            'Hopphopp ‚Äì 2 √ó 40',
            'Inchworm ‚Äì 1 √ó 6',
            'Dynamisk h√∂ft√∂ppnare ‚Äì 1 √ó 10/ben',
            '‚Äî Cirkel, 4 varv (45 sek / 15 sek vila) ‚Äî',
            'Goblet squat',
            'Kettlebell swing (alt. hantelsvings)',
            'Push-ups (breda)',
            'Utfallssteg med hopp',
            'Rygglyft (golv)',
            'Triceps dips (stol/b√§nk)',
            '‚Äî Nedvarvning (5 min) ‚Äî',
            'H√∂ftstr√§ckning ‚Äì 60 sek',
            'Br√∂ststr√§ckning ‚Äì 60 sek',
            'Sit and reach ‚Äì 60 sek',
        ]
    },
    {
        id: 'hiit_uthallighet',
        title: 'Uth√•llighets-circuit',
        subtitle: '5 varv ¬∑ Fler √∂vningar ¬∑ 30 sek / 15 sek',
        emoji: 'üåä',
        color: '#22d3ee',
        duration: '45‚Äì55 min',
        exercises: [
            '‚Äî Uppv√§rmning (5 min) ‚Äî',
            'L√§tt jogg p√• st√§llet ‚Äì 3 min',
            'Axelrotationer ‚Äì 1 √ó 20',
            'Hip circles ‚Äì 1 √ó 10/ben',
            '‚Äî Cirkel, 5 varv (30 sek / 15 sek vila) ‚Äî',
            'Jumping jacks',
            'Squat pulsar',
            'Push-ups (smala)',
            'High knees',
            'Sidoutfall',
            'Armh√§vning med rotation',
            'Crunch',
            'Sidoplanka (v√§xla sidor)',
            '‚Äî Nedvarvning (5 min) ‚Äî',
            'Full kroppsstretching ‚Äì 5 min',
        ]
    },
];

const EXERCISE_IMAGES = {
    // Br√∂st & Triceps
    'Lutande hantelpress':  'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Incline-Dumbbell-Bench-Press_c2bf89a2-433f-4a8f-9801-67c679980867_600x600.png?v=1612138008',
    'Rak hantelpress':      'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Dumbbell-Bench-Press_13090f67-ccfc-4f3a-9bab-e75d753fa9fa_600x600.png?v=1612137970',
    'B√§nkpress':            'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Barbell-Bench-Press_0316b783-43b2-44f8-8a2b-b177a2cfcbfc_600x600.png?v=1612137800',
    'Low cable chest':      'https://www.hsefitness.com/wp-content/uploads/2025/01/High-to-Low-Cable-Crossover-600x600.png',
    'Pushdowns':            'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Triceps-Pressdown_e759437b-6200-4b44-b484-14db770024a4_600x600.png?v=1612136845',
    'Pec deck':             'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Peck-Deck_600x600.png?v=1612137910',
    'Br√∂stpress':           'https://privatetrainingonline.se/wp-content/uploads/2018/04/Brostpress-Private-Training-Online-e1671284232699.jpg',
    // Rygg & Biceps
    'Latsdrag':             'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Wide-Grip-Pulldown_91fcba9b-47a2-4185-b093-aa542c81c55c_600x600.png?v=1612138105',
    'Sittande rodd':        'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Seated-Cable-Row_9470fa48-f0d1-40b1-a980-caee9e6f2e53_600x600.png?v=1612138127',
    'Hyperextensions':      'https://weighttraining.guide/wp-content/uploads/2016/10/45-degree-hyperextension.png',
    'Preacher curl':        'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/EZ-Barbell-Preacher-Curl_4d449fee-1920-4137-970c-75d4698b268d_600x600.png?v=1612137254',
    'Bak√•tlutad bicepcurl': 'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Incline-Dumbbell-Curl_7debf468-cd34-49bc-8933-7f4b087e6cca_600x600.png?v=1612137309',
    'Cable curl':           'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Rope-Cable-Curl_6216e254-5f77-462c-9954-ea210fff8a70_600x600.png?v=1612137195',
    'One arm cable curl':   'https://fitnessprogramer.com/wp-content/uploads/2021/02/One-Arm-Cable-Curl.gif',
    // Axlar & Mage
    'Milit√§rpress':         'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Dumbbell-Shoulder-Press_da0aa742-620a-45f7-9277-78137d38ff28_600x600.png?v=1612138495',
    'Sidolyft':             'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Dumbbell-Lateral-Raise_31c81eee-81c4-4ffe-890d-ee13dd5bbf20_600x600.png?v=1612138523',
    'Framlyft':             'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Dumbbell-Front-Raise_11804c3c-22d1-4589-a035-e30ad72149f3_600x600.png?v=1612138576',
    'Face pull':            'https://privatetrainingonline.se/wp-content/uploads/2021/12/Facepull-Ryggovning-PTO-e1709981314551.jpeg',
    'Plankan (sek)':        'https://cdn.shopify.com/s/files/1/0269/5551/3900/files/Plank_3a82d566-9cb2-4c20-b301-bc8bd635c4d1_600x600.png?v=1612138431',
    'Dead bug':             'https://media.self.com/photos/580a37dc7f7be8915ea98685/master/w_1600%2Cc_limit/dead-bug_ab-stacked.jpg',
    'Sidoplanka (sek)':     'https://liftmanual.com/wp-content/uploads/2023/04/side-plank-leg-lift.jpg',
    'Hjulet':               'https://i5.walmartimages.com/asr/90b2c6cd-1ae5-4bbc-bd73-27272266f0cc.4249099862bc92bf028c4c2c86877dcb.jpeg',
    // Nya √∂vningar
    'High to low cable flyes (drag curl)': 'https://www.puregym.com/media/0c2ijzzq/cable-chest-flyes.jpg?quality=80',
    'Low to high cable fly':        'https://cdn.shopify.com/s/files/1/1633/7705/files/cable_flys_low_480x480.jpg',
    'Overhead tricep extension':    'https://www.puregym.com/media/b5jl1ij3/overhead-tricep-extension.jpg?quality=80',
    'Cable kickback triceps':       'https://s3.amazonaws.com/prod.skimble/assets/2597476/image_iphone.jpg',
    // Ben & Rumpa
    'Kn√§b√∂j':               'https://privatetrainingonline.se/wp-content/uploads/2015/01/Knaboj-varianter-Goblet-Squat.jpg',
    'Benpress':             'https://www.mathiaszachau.com/wp-content/uploads/2018/03/benpressens-biomekanik-muskelaktivering-illustration-1.jpg',
    'Leg extension':        'https://training.fit/wp-content/uploads/2020/03/beinstrecken-geraet-1.png',
    'Leg curl':             'https://newlife.com.cy/wp-content/uploads/2019/08/seated-leg-curl-990x557.png',
    'Utfall':               'https://static.vecteezy.com/ti/gratis-vektor/p1/26177950-kvinna-haller-pa-med-utfall-steg-posten-traning-trana-for-de-rumpa-och-hofter-vector.jpg',
    'Hip thrust':           'https://weighttraining.guide/wp-content/uploads/2017/04/barbell-hip-thrust-resized.png',
    'Romanian deadlift':    'https://www.inspireusafoundation.org/file/2022/06/barbell-romanian-deadlift-benefits-1024x576.jpg',
    'Sumo kn√§b√∂j':          'https://www.kettlebellkings.com/cdn/shop/articles/Kettlebell_Sumo_Squat.jpg?v=1732016655',
    'Cable kickback':       'https://anabolicaliens.com/cdn/shop/articles/1280_684e5ae5-84dd-41af-ae4e-1bd3655083d1.png',
};

// √ñvningar med varianter (dropdown i kortet)
const VARIANT_EXERCISES = {
    'Latsdrag':      ['Maskin', 'Cable'],
    'Sittande rodd': ['Maskin', 'Cable'],
    'Preacher curl': ['Maskin', 'Hantlar'],
};

// Gamla √∂vningsnamn ‚Üí nytt namn (visas i historiken med nytt namn)
const EXERCISE_RENAMES = {
    'Drag curl': 'Low cable chest',
    'Single arm cable extension': 'Cable kickback triceps',
    'Good morning': 'Hyperextensions',
    'Low cable flyes': 'High to low cable flyes (drag curl)',
};

let currentUser = null;
let currentType = null;
let currentProgram = null;
let selectedDifficulty = 0;
let selectedActivity = null;
let localWorkouts = [];
let unsubscribeListener = null;
let editingWorkout = null;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('home-date').textContent = new Date().toLocaleDateString('sv-SE', {
    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
});

const _savedUser = localStorage.getItem('traning_current_user');
if (_savedUser) {
    selectUser(_savedUser, true);
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
}

function selectUser(name, silent = false) {
    currentUser = name;
    localStorage.setItem('traning_current_user', name);
    document.getElementById('home-greeting-name').textContent = `Hej, ${name}! üí™`;

    if (unsubscribeListener) unsubscribeListener();
    unsubscribeListener = userRef()
        .orderBy('date')
        .onSnapshot(snapshot => {
            localWorkouts = snapshot.docs.map(doc => doc.data());
            updateLastSessions();
            if (document.getElementById('screen-history').classList.contains('active')) {
                showHistory();
            }
        }, () => toast('Kunde inte ansluta till molnet', true));

    if (!silent) showScreen('screen-home');
    else {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-home').classList.add('active');
    }
}

function switchUser() {
    currentUser = null;
    localWorkouts = [];
    if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; }
    localStorage.removeItem('traning_current_user');
    showScreen('screen-user');
}

function goHome() {
    showScreen('screen-home');
    updateLastSessions();
    selectedActivity = null;
    currentProgram = null;
    selectedDifficulty = 0;
    editingWorkout = null;
    document.querySelector('.save-btn').textContent = 'Spara tr√§ningspass';
}

function startWorkout(type) {
    currentType = type;

    if (type === 'cardio') {
        document.querySelectorAll('.act-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('cardio-time').value = '';
        document.getElementById('cardio-kcal').value = '';
        showScreen('screen-cardio');
        return;
    }

    const data = WORKOUTS[type];
    const prev = getPrevious(type);

    document.getElementById('workout-title').textContent = data.title;
    document.getElementById('workout-badge').textContent = data.title;
    document.getElementById('workout-badge').style.background = data.color;
    document.getElementById('workout-date').textContent = new Date().toLocaleDateString('sv-SE');

    if (prev) {
        const d = new Date(prev.date).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
        document.getElementById('prev-session-info').textContent = `F√∂rra passet: ${d}`;
    } else {
        document.getElementById('prev-session-info').textContent = '';
    }

    const list = document.getElementById('exercises-list');
    list.innerHTML = '';

    const _allHistory = getStorage();
    function _getLastPerformed(name) {
        const sorted = [..._allHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
        for (const w of sorted) {
            if (w.exercises && w.exercises.some(e => e.name === name)) {
                return new Date(w.date).getTime();
            }
        }
        return 0;
    }

    (data.groups || []).forEach(group => {
        const hdr = document.createElement('div');
        hdr.className = 'ex-section-head';
        hdr.textContent = group.label;
        list.appendChild(hdr);

        const sortedEx = [...group.exercises].sort((a, b) => _getLastPerformed(b) - _getLastPerformed(a));
        sortedEx.forEach(name => {
            const aliases = getExerciseAliases(name);
            const prevEx = prev ? prev.exercises.find(e => aliases.includes(e.name)) : null;
            list.appendChild(buildExerciseCard(name, prevEx));
        });
    });

    showScreen('screen-workout');
}

function editWorkout(id) {
    const w = localWorkouts.find(w => w.id === id);
    if (!w) return;

    editingWorkout = w;
    currentType = w.type;
    const data = WORKOUTS[w.type];
    if (!data) return;

    document.getElementById('workout-title').textContent = data.title;
    document.getElementById('workout-badge').textContent = data.title;
    document.getElementById('workout-badge').style.background = data.color;
    document.getElementById('workout-date').textContent = new Date(w.date).toLocaleDateString('sv-SE');
    document.getElementById('prev-session-info').textContent = '‚úèÔ∏è Redigerar ‚Äì datum √§ndras ej';
    document.querySelector('.save-btn').textContent = 'Spara √§ndringar';

    const list = document.getElementById('exercises-list');
    list.innerHTML = '';

    (data.groups || []).forEach(group => {
        const hdr = document.createElement('div');
        hdr.className = 'ex-section-head';
        hdr.textContent = group.label;
        list.appendChild(hdr);

        group.exercises.forEach(name => {
            let savedEx = w.exercises.find(e => e.name === name);
            let initialVariant = null;
            if (!savedEx && VARIANT_EXERCISES[name]) {
                for (const v of VARIANT_EXERCISES[name]) {
                    const found = w.exercises.find(e => e.name === `${name} (${v.toLowerCase()})`);
                    if (found) { savedEx = found; initialVariant = v.toLowerCase(); break; }
                }
            }
            // currentSets = [] for unlogged exercises (starts empty), savedEx.sets if logged
            list.appendChild(buildExerciseCard(name, null, null, savedEx ? savedEx.sets : [], initialVariant));
        });
    });

    showScreen('screen-workout');
}

// ‚îÄ‚îÄ WEEK HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWeekStart(dateVal) {
    const d = new Date(dateVal);
    const day = d.getDay(); // 0=s√∂n, 1=m√•n ...
    const diff = day === 0 ? -6 : 1 - day; // justera till m√•ndag
    d.setDate(d.getDate() + diff);
    d.setHours(0, 0, 0, 0);
    return d;
}

function showHistory() {
    const workouts = getStorage();
    const container = document.getElementById('history-list');

    if (workouts.length === 0) {
        container.innerHTML = '<div class="history-empty">Inga tr√§ningspass sparade √§n.</div>';
        showScreen('screen-history');
        return;
    }

    const sorted = [...workouts].sort((a, b) => new Date(b.date) - new Date(a.date));
    const currentYear = new Date().getFullYear();
    let html = '';
    let currentWeekKey = null;

    sorted.forEach((w, i) => {
        const ws = getWeekStart(w.date);
        const we = new Date(ws);
        we.setDate(we.getDate() + 6);
        const weekKey = ws.toISOString().slice(0, 10);

        if (weekKey !== currentWeekKey) {
            if (currentWeekKey !== null) html += '</div>';
            currentWeekKey = weekKey;
            const opts = { day: 'numeric', month: 'short' };
            const startStr = ws.toLocaleDateString('sv-SE', opts);
            const endStr   = we.toLocaleDateString('sv-SE', ws.getFullYear() !== currentYear ? { ...opts, year: 'numeric' } : opts);
            html += `<div class="week-group"><div class="week-header"><span>${startStr} ‚Äì ${endStr}</span></div>`;
        }
        html += buildHistoryItem(w, i);
    });

    if (currentWeekKey !== null) html += '</div>';
    container.innerHTML = html;
    showScreen('screen-history');
}

// ‚îÄ‚îÄ STATISTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getISOWeek(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function showStats() {
    const workouts = getStorage();
    const now = new Date();

    if (workouts.length === 0) {
        document.getElementById('stats-body').innerHTML =
            '<div class="history-empty">Inga tr√§ningspass loggade √§n.</div>';
        showScreen('screen-stats');
        return;
    }

    const weekStart  = getWeekStart(now);
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

    // ‚îÄ‚îÄ Sammanfattning ‚îÄ‚îÄ
    const totalCount = workouts.length;
    const thisWeek   = workouts.filter(w => new Date(w.date) >= weekStart).length;
    const thisMonth  = workouts.filter(w => new Date(w.date) >= monthStart).length;

    let weekStreak = 0;
    let checkWs = getWeekStart(now);
    while (true) {
        const checkWe = new Date(checkWs); checkWe.setDate(checkWe.getDate() + 7);
        if (workouts.some(w => { const d = new Date(w.date); return d >= checkWs && d < checkWe; })) {
            weekStreak++;
            checkWs = new Date(checkWs); checkWs.setDate(checkWs.getDate() - 7);
        } else break;
    }

    // ‚îÄ‚îÄ L√§ngsta svit (dagar i rad) ‚îÄ‚îÄ
    const uniqueDates = [...new Set(workouts.map(w => w.date.slice(0, 10)))].sort();
    let maxDayStreak = uniqueDates.length > 0 ? 1 : 0, curStreak = 1;
    for (let i = 1; i < uniqueDates.length; i++) {
        const diff = Math.round((new Date(uniqueDates[i]) - new Date(uniqueDates[i-1])) / 86400000);
        if (diff === 1) { curStreak++; maxDayStreak = Math.max(maxDayStreak, curStreak); }
        else curStreak = 1;
    }

    // ‚îÄ‚îÄ Rekordvecka ‚îÄ‚îÄ
    const weekCounts = {};
    workouts.forEach(w => {
        const key = getWeekStart(w.date).toISOString().slice(0, 10);
        weekCounts[key] = (weekCounts[key] || 0) + 1;
    });
    const recordWeek = Object.values(weekCounts).length ? Math.max(...Object.values(weekCounts)) : 0;

    // ‚îÄ‚îÄ Favoritpass ‚îÄ‚îÄ
    const typeCounts = {};
    workouts.forEach(w => { typeCounts[w.type] = (typeCounts[w.type] || 0) + 1; });
    const typeShort = { brost:'Br√∂st', rygg:'Rygg', axlar:'Axlar', cardio:'Cardio', helkropp:'Helkropp', ben:'Ben' };
    const favTypeEntry = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0];
    const favTypeLabel = favTypeEntry ? (typeShort[favTypeEntry[0]] || favTypeEntry[0]) : '‚Äì';

    // ‚îÄ‚îÄ Tr√§ningstid p√• dygnet ‚îÄ‚îÄ
    const timeBuckets = { 'F√∂rmiddag': 0, 'Eftermiddag': 0, 'Kv√§ll': 0 };
    workouts.forEach(w => {
        const h = new Date(w.date).getHours();
        if (h < 12) timeBuckets['F√∂rmiddag']++;
        else if (h < 17) timeBuckets['Eftermiddag']++;
        else timeBuckets['Kv√§ll']++;
    });
    const favTime = Object.entries(timeBuckets).sort((a, b) => b[1] - a[1])[0][0];

    // ‚îÄ‚îÄ L√§ngsta vila (dagar mellan pass) ‚îÄ‚îÄ
    let longestBreak = 0;
    if (uniqueDates.length >= 2) {
        for (let i = 1; i < uniqueDates.length; i++) {
            const gap = Math.round((new Date(uniqueDates[i]) - new Date(uniqueDates[i-1])) / 86400000) - 1;
            longestBreak = Math.max(longestBreak, gap);
        }
    }

    // ‚îÄ‚îÄ Veckodagsf√∂rdelning ‚îÄ‚îÄ
    const DAY_NAMES = ['M√•n','Tis','Ons','Tor','Fre','L√∂r','S√∂n'];
    const dayCounts = [0,0,0,0,0,0,0];
    workouts.forEach(w => {
        const d = new Date(w.date).getDay();
        dayCounts[d === 0 ? 6 : d - 1]++;
    });
    const weekdayData = DAY_NAMES.map((label, i) => ({ label, count: dayCounts[i] }));
    const maxDayIdx = dayCounts.indexOf(Math.max(...dayCounts));
    const minDayIdx = dayCounts.indexOf(Math.min(...dayCounts));

    // ‚îÄ‚îÄ Veckodata v.X (senaste 12) ‚îÄ‚îÄ
    const weeklyData = [];
    for (let i = 11; i >= 0; i--) {
        const ws = getWeekStart(now); ws.setDate(ws.getDate() - i * 7);
        const we = new Date(ws); we.setDate(we.getDate() + 7);
        const count = workouts.filter(w => { const d = new Date(w.date); return d >= ws && d < we; }).length;
        weeklyData.push({ label: `v.${getISOWeek(ws)}`, count });
    }

    // ‚îÄ‚îÄ M√•nadsdata (senaste 12) ‚îÄ‚îÄ
    const monthlyData = [];
    for (let i = 11; i >= 0; i--) {
        const ms = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const me = new Date(now.getFullYear(), now.getMonth() - i + 1, 1);
        const count = workouts.filter(w => { const d = new Date(w.date); return d >= ms && d < me; }).length;
        monthlyData.push({ label: ms.toLocaleDateString('sv-SE', { month: 'short' }), count });
    }

    const avgPerWeek = (weeklyData.reduce((s, w) => s + w.count, 0) / 12).toFixed(1);

    document.getElementById('stats-body').innerHTML = `
        <div class="stats-summary">
            <div class="stat-card"><div class="stat-value">${totalCount}</div><div class="stat-label">Totalt</div></div>
            <div class="stat-card"><div class="stat-value">${thisWeek}</div><div class="stat-label">Den h√§r veckan</div></div>
            <div class="stat-card"><div class="stat-value">${thisMonth}</div><div class="stat-label">Den h√§r m√•naden</div></div>
            <div class="stat-card"><div class="stat-value">${weekStreak}</div><div class="stat-label">Veckor i rad üî•</div></div>
        </div>

        <div class="fun-stats-grid">
            <div class="fun-stat-card"><span class="fun-stat-emoji">üèÜ</span><div class="fun-stat-val">${recordWeek}</div><div class="fun-stat-desc">Rekordvecka</div></div>
            <div class="fun-stat-card"><span class="fun-stat-emoji">üî•</span><div class="fun-stat-val">${maxDayStreak}</div><div class="fun-stat-desc">Dagar i rad</div></div>
            <div class="fun-stat-card"><span class="fun-stat-emoji">üí™</span><div class="fun-stat-val" style="font-size:17px">${favTypeLabel}</div><div class="fun-stat-desc">Favoritpass</div></div>
            <div class="fun-stat-card"><span class="fun-stat-emoji">üìà</span><div class="fun-stat-val">${avgPerWeek}</div><div class="fun-stat-desc">Snitt/vecka</div></div>
            <div class="fun-stat-card"><span class="fun-stat-emoji">‚è∞</span><div class="fun-stat-val" style="font-size:15px">${favTime}</div><div class="fun-stat-desc">Tr√§ningstid</div></div>
            <div class="fun-stat-card"><span class="fun-stat-emoji">üò¥</span><div class="fun-stat-val">${longestBreak}</div><div class="fun-stat-desc">L√§ngsta vilan (dgr)</div></div>
        </div>

        <div class="chart-section">
            <div class="chart-title">Veckodagsf√∂rdelning</div>
            <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">
                Mest aktiv: <strong style="color:var(--text)">${DAY_NAMES[maxDayIdx]}</strong>
                &nbsp;¬∑&nbsp;
                Minst aktiv: <strong style="color:var(--text)">${DAY_NAMES[minDayIdx]}</strong>
            </div>
            ${buildBarChart(weekdayData, maxDayIdx)}
        </div>

        <div class="chart-section">
            <div class="chart-title">Pass per vecka ‚Äì senaste 12 veckorna</div>
            ${buildBarChart(weeklyData)}
        </div>

        <div class="chart-section">
            <div class="chart-title">Pass per m√•nad ‚Äì senaste 12 m√•naderna</div>
            ${buildBarChart(monthlyData)}
        </div>`;

    showScreen('screen-stats');
}

function buildBarChart(data, highlightIdx = -1) {
    const maxCount = Math.max(...data.map(d => d.count), 1);
    const BAR_MAX_H = 100;
    return '<div class="bar-chart">' + data.map((d, i) => {
        const h = Math.round((d.count / maxCount) * BAR_MAX_H);
        const hl = i === highlightIdx;
        return `<div class="bar-group">
            <div class="bar-val" style="${hl ? 'color:#ff6b6b' : ''}">${d.count > 0 ? d.count : ''}</div>
            <div class="bar-col" style="height:${h}px${hl ? ';background:linear-gradient(to top,#cc4444,#ff6b6b)' : ''}"></div>
            <div class="bar-lbl">${d.label}</div>
        </div>`;
    }).join('') + '</div>';
}

// ‚îÄ‚îÄ HELKROPPSPASS (slump) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startRandomHelkropp() {
    const prog = HELKROPP_PROGRAMS[Math.floor(Math.random() * HELKROPP_PROGRAMS.length)];
    currentProgram = prog;
    selectedDifficulty = 0;

    document.getElementById('prog-session-title').textContent = prog.title;

    const card = document.getElementById('prog-session-card');
    card.style.setProperty('--pc', prog.color);
    card.innerHTML = `
        <span class="prog-session-emoji">${prog.emoji}</span>
        <div class="prog-session-name">${prog.title}</div>
        <div class="prog-session-sub">${prog.subtitle}</div>
        <div class="prog-session-sub">‚è± ${prog.duration}</div>
    `;

    const exList = document.getElementById('prog-ex-list');
    exList.innerHTML = prog.exercises.map(ex => {
        if (ex.startsWith('‚Äî')) {
            return `<div class="prog-ex-section">${ex.replace(/‚Äî/g, '').trim()}</div>`;
        }
        return `<div class="prog-ex-item">¬∑ ${ex}</div>`;
    }).join('');

    updateStars(0);
    showScreen('screen-programs');
}

function setDifficulty(n) {
    selectedDifficulty = n;
    updateStars(n);
}

function updateStars(n) {
    const labels = ['Hur jobbigt var det?', 'V√§ldigt l√§tt üò¥', 'L√§tt üôÇ', 'Lagom üí™', 'Tungt üò§', 'Extremt jobbigt üî•'];
    document.querySelectorAll('.diff-star').forEach((s, i) => {
        s.classList.toggle('active', i < n);
    });
    document.getElementById('diff-label').textContent = labels[n];
}

function saveProgramSession() {
    if (selectedDifficulty === 0) {
        toast('V√§lj sv√•righetsgrad!', true);
        return;
    }
    saveToStorage({
        id: Date.now(),
        date: new Date().toISOString(),
        type: 'helkropp',
        title: currentProgram.title,
        isProgram: true,
        programId: currentProgram.id,
        emoji: currentProgram.emoji,
        difficulty: selectedDifficulty,
    });
    toast('Tr√§ningspass sparat!');
    setTimeout(goHome, 1600);
}

// ‚îÄ‚îÄ EXERCISE CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildExerciseCard(name, prevEx, templateEx = null, currentSets = null, initialVariant = null) {
    const div = document.createElement('div');
    div.className = 'ex-card';

    const variants = VARIANT_EXERCISES[name];
    const hasVariants = !!variants;
    const activeVariant = initialVariant || (hasVariants ? variants[0].toLowerCase() : null);
    const effectiveName = hasVariants ? `${name} (${activeVariant})` : name;

    if (hasVariants) {
        div.dataset.baseName = name;
        div.dataset.effectiveName = effectiveName;
        if (!prevEx && currentSets === null) {
            const prev = getPrevious(currentType);
            const aliases = getExerciseAliases(effectiveName);
            prevEx = prev ? prev.exercises.find(e => aliases.includes(e.name)) : null;
        }
    }

    const imgUrl = EXERCISE_IMAGES[effectiveName] || EXERCISE_IMAGES[name];
    const imgHtml = imgUrl
        ? `<img class="ex-thumb" src="${imgUrl}" alt="${name}" onclick="openLightbox('${imgUrl}',event)" title="Klicka f√∂r att f√∂rstora">`
        : '';

    const pb = getExercisePB(effectiveName);
    const pbText = pb !== null ? `PB: ${pb.weight} kg √ó ${pb.reps} reps` : '';
    const pbHtml = `<div class="ex-pb">${pbText}</div>`;

    const variantHtml = hasVariants
        ? `<select class="variant-select" onchange="changeVariant(this)">${variants.map(v => `<option value="${v.toLowerCase()}"${v.toLowerCase() === activeVariant ? ' selected' : ''}>${v}</option>`).join('')}</select>`
        : '';

    div.innerHTML = `
        <div class="ex-header">
            <div>
                <span class="ex-name">${name}</span>
                ${variantHtml}
                ${pbHtml}
            </div>
            ${imgHtml}
        </div>
        <table class="sets-table">
            <thead>
                <tr>
                    <th style="width:36px">Set</th>
                    <th>Vikt (kg)</th>
                    <th>Reps</th>
                    <th></th>
                </tr>
            </thead>
            <tbody class="sets-body"></tbody>
        </table>
        <button class="add-set-btn" onclick="addSet(this)">+ L√§gg till set</button>
    `;

    const prevSets = prevEx ? prevEx.sets : [];
    const setsToAdd = currentSets !== null
        ? currentSets.length
        : (prevSets.length > 0 ? prevSets.length : (templateEx ? templateEx.sets : 3));
    const btn = div.querySelector('.add-set-btn');

    for (let i = 0; i < setsToAdd; i++) {
        const hasPrev = !!prevSets[i];
        addSet(btn, prevSets[i] || null, (!hasPrev && templateEx) ? templateEx : null, currentSets ? currentSets[i] || null : null);
    }

    return div;
}

function changeVariant(select) {
    const card = select.closest('.ex-card');
    const baseName = card.dataset.baseName;
    const variant = select.value;
    const effectiveName = `${baseName} (${variant})`;
    card.dataset.effectiveName = effectiveName;

    // Uppdatera PB
    const pb = getExercisePB(effectiveName);
    const pbEl = card.querySelector('.ex-pb');
    pbEl.textContent = pb !== null ? `PB: ${pb.weight} kg √ó ${pb.reps} reps` : '';

    // H√§mta f√∂rra passets sets f√∂r den valda varianten
    const prev = getPrevious(currentType);
    const aliases = getExerciseAliases(effectiveName);
    const prevEx = prev ? prev.exercises.find(e => aliases.includes(e.name)) : null;
    const prevSets = prevEx ? prevEx.sets : [];

    card.querySelectorAll('.set-row').forEach((row, i) => {
        const prevSet = prevSets[i];
        const tds = row.querySelectorAll('td');
        const wInput = tds[1].querySelector('.set-input');
        const rInput = tds[2].querySelector('.set-input');
        let wHint = tds[1].querySelector('.prev-val');
        let rHint = tds[2].querySelector('.prev-val');

        if (prevSet) {
            if (!wHint) { wHint = document.createElement('div'); wHint.className = 'prev-val'; tds[1].appendChild(wHint); }
            if (!rHint) { rHint = document.createElement('div'); rHint.className = 'prev-val'; tds[2].appendChild(rHint); }
            wHint.textContent = `F√∂rra: ${prevSet.weight} kg`;
            rHint.textContent = `F√∂rra: ${prevSet.reps}`;
            if (wInput) wInput.placeholder = prevSet.weight;
            if (rInput) rInput.placeholder = prevSet.reps;
        } else {
            if (wHint) wHint.textContent = '';
            if (rHint) rHint.textContent = '';
            if (wInput) wInput.placeholder = '0';
            if (rInput) rInput.placeholder = '0';
        }
    });

    // Uppdatera bild
    const imgUrl = EXERCISE_IMAGES[effectiveName] || EXERCISE_IMAGES[baseName];
    const img = card.querySelector('.ex-thumb');
    if (img && imgUrl) {
        img.src = imgUrl;
        img.setAttribute('onclick', `openLightbox('${imgUrl}',event)`);
    }
}

function addSet(btn, prevSet = null, templateEx = null, currentSet = null) {
    const tbody = btn.closest('.ex-card').querySelector('.sets-body');
    const num = tbody.querySelectorAll('.set-row').length + 1;

    const tr = document.createElement('tr');
    tr.className = 'set-row';

    const prevWeight  = prevSet ? prevSet.weight : '';
    const prevReps    = prevSet ? prevSet.reps : '';
    const suggestReps = templateEx ? templateEx.reps : '';

    const hintW = prevSet ? `<div class="prev-val">F√∂rra: ${prevWeight} kg</div>` : '';
    const hintR = prevSet
        ? `<div class="prev-val">F√∂rra: ${prevReps}</div>`
        : (templateEx ? `<div class="prev-val" style="color:#58a6ff">F√∂rslag: ${suggestReps} reps</div>` : '');

    tr.innerHTML = `
        <td class="set-num">${num}</td>
        <td>
            <input class="set-input" type="text" inputmode="decimal"
                   placeholder="${prevWeight || '0'}" pattern="[0-9]*[.,]?[0-9]*"
                   ${currentSet ? `value="${currentSet.weight}"` : ''}>
            ${hintW}
        </td>
        <td>
            <input class="set-input" type="number"
                   placeholder="${prevReps || suggestReps || '0'}" min="0" inputmode="numeric"
                   ${currentSet ? `value="${currentSet.reps}"` : ''}>
            ${hintR}
        </td>
        <td><button class="del-set" onclick="deleteSet(this)" title="Ta bort set">√ó</button></td>
    `;
    tbody.appendChild(tr);
}

function deleteSet(btn) {
    const tbody = btn.closest('.sets-body');
    btn.closest('.set-row').remove();
    tbody.querySelectorAll('.set-row').forEach((r, i) => {
        r.querySelector('.set-num').textContent = i + 1;
    });
}

// ‚îÄ‚îÄ CARDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectActivity(el, activity) {
    document.querySelectorAll('.act-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedActivity = activity;
}

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveWorkout() {
    const exercises = [];

    document.querySelectorAll('.ex-card').forEach(card => {
        const name = card.dataset.effectiveName || card.querySelector('.ex-name').textContent;
        const sets = [];

        card.querySelectorAll('.set-row').forEach(row => {
            const inputs = row.querySelectorAll('.set-input');
            const weight = inputs[0].value.trim().replace(',', '.');
            const reps   = inputs[1].value.trim();
            if (weight !== '' || reps !== '') {
                sets.push({ weight: weight || '0', reps: reps || '0' });
            }
        });

        if (sets.length > 0) exercises.push({ name, sets });
    });

    if (exercises.length === 0) {
        toast('Fyll i minst en √∂vning!', true); return;
    }

    saveToStorage({
        id:    editingWorkout ? editingWorkout.id   : Date.now(),
        date:  editingWorkout ? editingWorkout.date : new Date().toISOString(),
        type: currentType,
        title: WORKOUTS[currentType] ? WORKOUTS[currentType].title : currentType,
        exercises
    });

    toast(editingWorkout ? 'Pass uppdaterat!' : 'Tr√§ningspass sparat!');
    editingWorkout = null;
    setTimeout(goHome, 1600);
}

function saveCardio() {
    if (!selectedActivity) { toast('V√§lj en aktivitet!', true); return; }

    const time = document.getElementById('cardio-time').value.trim();
    const kcal = document.getElementById('cardio-kcal').value.trim();

    if (!time || !kcal) { toast('Fyll i tid och kalorier!', true); return; }

    const LABELS = { cykel: 'Cykel', promenad: 'Promenad', crosstrainer: 'Crosstrainer' };

    saveToStorage({
        id: Date.now(),
        date: new Date().toISOString(),
        type: 'cardio',
        title: 'Cardio',
        activity: selectedActivity,
        activityLabel: LABELS[selectedActivity],
        time: parseInt(time),
        kcal: parseInt(kcal)
    });

    toast('Cardio sparat!');
    setTimeout(goHome, 1600);
}

// ‚îÄ‚îÄ HISTORY VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildHistoryItem(w, i) {
    const date = new Date(w.date).toLocaleString('sv-SE', {
        weekday: 'short', day: 'numeric', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });

    let bodyHtml = '';
    if (w.isProgram) {
        const stars = '‚òÖ'.repeat(w.difficulty) + '‚òÜ'.repeat(5 - w.difficulty);
        bodyHtml = `
            <div class="hist-prog-row">
                ${w.emoji || ''} ${w.title}<br>
                <span class="hist-prog-stars">${stars}</span>
                <span style="font-size:12px;margin-left:6px;">Sv√•righet ${w.difficulty}/5</span>
            </div>`;
    } else if (w.type === 'cardio') {
        const ICONS = { cykel: 'üö¥', promenad: 'üö∂', crosstrainer: 'üéø' };
        bodyHtml = `
            <div class="hist-cardio-info">
                ${ICONS[w.activity] || ''} <strong>${w.activityLabel}</strong> &nbsp;|&nbsp;
                <strong>${w.time}</strong> min &nbsp;|&nbsp;
                <strong>${w.kcal}</strong> kcal
            </div>`;
    } else {
        bodyHtml = (w.exercises || []).map(ex => `
            <div class="hist-ex">
                <div class="hist-ex-name">${EXERCISE_RENAMES[ex.name] || ex.name}</div>
                <div class="hist-sets">
                    ${ex.sets.map((s, si) => `
                        <span class="hist-set-pill">${si+1}. ${s.weight} kg √ó ${s.reps}</span>
                    `).join('')}
                </div>
            </div>`).join('');
    }

    const editBtn = (!w.isProgram && w.type !== 'cardio' && WORKOUTS[w.type])
        ? `<button class="hist-edit-btn" onclick="event.stopPropagation(); editWorkout(${w.id})" title="Redigera">‚úèÔ∏è</button>`
        : '';

    return `
        <div class="hist-item">
            <div class="hist-header" onclick="toggleHistory(this)">
                <span class="hist-title">${w.title}</span>
                <span class="hist-date">${date}</span>
                ${editBtn}
                <span class="hist-chevron">‚ñº</span>
            </div>
            <div class="hist-body">
                ${bodyHtml}
                <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--surface2);text-align:right;">
                    <button class="hist-delete-btn" onclick="deleteWorkout(${w.id})" title="Ta bort">üóë Ta bort pass</button>
                </div>
            </div>
        </div>`;
}

function toggleHistory(header) {
    header.classList.toggle('open');
    header.nextElementSibling.classList.toggle('open');
}

// ‚îÄ‚îÄ HOME CARD LAST SESSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateLastSessions() {
    ['brost', 'rygg', 'axlar', 'cardio', 'ben'].forEach(type => {
        const prev = getPrevious(type);
        const el = document.getElementById(`last-${type}`);
        if (prev) {
            const d = new Date(prev.date).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
            el.textContent = `Senast: ${d}`;
        } else {
            el.textContent = '';
        }
    });
}

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStorage() {
    return localWorkouts;
}

function saveToStorage(entry) {
    userRef().doc(String(entry.id)).set(entry)
        .catch(() => toast('Kunde inte spara!', true));
}

function deleteWorkout(id) {
    if (!confirm('Ta bort tr√§ningspass?')) return;
    userRef().doc(String(id)).delete()
        .catch(() => toast('Kunde inte radera!', true));
}

function getPrevious(type) {
    return getStorage()
        .filter(w => w.type === type)
        .sort((a, b) => new Date(b.date) - new Date(a.date))[0] || null;
}

function getExerciseAliases(name) {
    const aliases = [name];
    for (const [oldName, newName] of Object.entries(EXERCISE_RENAMES)) {
        if (newName === name) aliases.push(oldName);
    }
    // Om det √§r en variant√∂vning som "Latsdrag (maskin)", inkludera basnamnet som alias
    for (const [baseName, variants] of Object.entries(VARIANT_EXERCISES)) {
        if (variants.some(v => name === `${baseName} (${v.toLowerCase()})`)) {
            aliases.push(baseName);
        }
    }
    return aliases;
}

function getExercisePB(exerciseName) {
    const aliases = getExerciseAliases(exerciseName);
    let pb = null;
    getStorage().forEach(workout => {
        if (!workout.exercises) return;
        workout.exercises.forEach(ex => {
            if (!aliases.includes(ex.name)) return;
            ex.sets.forEach(s => {
                const w = parseFloat(String(s.weight).replace(',', '.'));
                if (!isNaN(w) && w >= 0 && (pb === null || w > pb.weight)) {
                    pb = { weight: w, reps: s.reps };
                }
            });
        });
    });
    return pb;
}

// ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openLightbox(src, e) {
    e.stopPropagation();
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('open');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, isError = false) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast' + (isError ? ' error' : '') + ' show';
    setTimeout(() => el.classList.remove('show'), 2400);
}
</script>
<div class="signature">Made by: David Hefner</div>
</body>
</html>
